{% extends "base.html" %}
{% load static %}

{% block title %}Discover Blogs - BlogHub{% endblock %}

{% block maincontent %}
<div class="reels-container">
  <!-- Blog Reels Feed -->
  <div id="reels-feed" class="reels-feed">
    <!-- Blogs will be loaded here -->
  </div>

  <!-- Navigation Arrows -->
  <div class="nav-arrows">
    <button id="prev-blog" class="nav-arrow nav-up" title="Previous Blog">
      <i class="fas fa-chevron-up"></i>
    </button>
    <button id="next-blog" class="nav-arrow nav-down" title="Next Blog">
      <i class="fas fa-chevron-down"></i>
    </button>
  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="spinner"></div>
  </div>

  <!-- Exit Button -->
  <a href="{% url 'blogs' %}" class="exit-reels">
    <i class="fas fa-times"></i>
  </a>
</div>

<style>
  /* Reset and Base */
  body {
    overflow: hidden;
    margin: 0;
    padding: 0;
  }

  /* Hide nav and footer on reel view */
  nav, footer {
    display: none !important;
  }

  .reels-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: #000;
    overflow: hidden;
    z-index: 9999;
  }

  /* Reels Feed */
  .reels-feed {
    width: 100%;
    height: 100vh;
    position: relative;
    scroll-snap-type: y mandatory;
    overflow-y: scroll;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  .reels-feed::-webkit-scrollbar {
    display: none;
  }

  /* Blog Reel Item */
  .blog-reel {
    width: 100%;
    height: 100vh;
    position: relative;
    scroll-snap-align: start;
    scroll-snap-stop: always;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Background Image with Overlay */
  .blog-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
  }

  .blog-background img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    filter: brightness(0.4);
  }

  .blog-background::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(180deg, 
      rgba(0,0,0,0.3) 0%, 
      rgba(0,0,0,0.6) 50%, 
      rgba(0,0,0,0.9) 100%);
  }

  /* Blog Content Overlay */
  .blog-overlay {
    position: relative;
    z-index: 2;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding: 2rem;
    color: white;
  }

  /* Top Bar */
  .blog-top-bar {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    padding: 1.5rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, transparent 100%);
  }

  .blog-category-tag {
    background: #3498db;
    padding: 0.5rem 1rem;
    border-radius: 0;
    font-weight: 600;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    border: 2px solid #3498db;
  }

  .blog-author-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    padding: 0.5rem 1rem;
    border-radius: 0;
    border: 2px solid #3498db;
  }

  .author-avatar {
    width: 32px;
    height: 32px;
    border-radius: 0;
    background: #3498db;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.9rem;
    border: 2px solid #3498db;
  }

  /* Content Area */
  .blog-content-area {
    max-width: 800px;
    margin: 0 auto;
    width: 100%;
  }

  .blog-title-reel {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    line-height: 1.2;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
  }

  .blog-excerpt-reel {
    font-size: 1.1rem;
    line-height: 1.6;
    margin-bottom: 1.5rem;
    max-height: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 6;
    -webkit-box-orient: vertical;
    text-shadow: 0 1px 5px rgba(0, 0, 0, 0.5);
  }

  .blog-meta-reel {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
    font-size: 0.95rem;
    opacity: 0.9;
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* Interaction Bar */
  .blog-interaction-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .interaction-left {
    display: flex;
    gap: 1rem;
  }

  .reel-btn {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 2px solid whitesmoke;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 0;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
  }

  .reel-btn:hover {
    background: #3498db;
    transform: scale(1.05);
  }

  .reel-btn.active {
    background: #3498db;
    border-color: #3498db;
  }

  .like-btn.active {
    background: #2ecc71;
    border-color: #2ecc71;
  }

  .dislike-btn.active {
    background: #e74c3c;
    border-color: #e74c3c;
  }

  .view-full-reel-btn {
    background: #3498db;
    border: 2px solid #3498db;
    padding: 0.75rem 1.5rem;
    border-radius: 0;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .view-full-reel-btn:hover {
    transform: scale(1.05);
    background: #2980b9;
    border-color: #2980b9;
    color: white;
  }

  /* Side Stats */
  .blog-side-stats {
    position: absolute;
    right: 2rem;
    bottom: 8rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    z-index: 3;
  }

  .stat-circle {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    padding: 1rem;
    border-radius: 0;
    width: 60px;
    height: 60px;
    justify-content: center;
    border: 2px solid whitesmoke;
  }

  .stat-circle i {
    font-size: 1.5rem;
  }

  .stat-circle span {
    font-size: 0.8rem;
    font-weight: 600;
  }

  /* Navigation Arrows */
  .nav-arrows {
    position: fixed;
    right: 2rem;
    top: 50%;
    transform: translateY(-50%);
    z-index: 100;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .nav-arrow {
    width: 50px;
    height: 50px;
    border-radius: 0;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 2px solid whitesmoke;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 1.2rem;
  }

  .nav-arrow:hover {
    background: #3498db;
    transform: scale(1.1);
  }

  .nav-arrow:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  /* Blog Counter */
  .blog-counter {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    padding: 0.75rem 1.5rem;
    border-radius: 0;
    color: white;
    font-weight: 600;
    border: 2px solid whitesmoke;
  }

  /* Loading Overlay */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .loading-overlay.active {
    display: flex;
  }

  .spinner {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top: 4px solid #3498db;
    border-radius: 0;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Exit Button */
  .exit-reels {
    position: fixed;
    top: 2rem;
    right: 2rem;
    width: 50px;
    height: 50px;
    border-radius: 0;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 2px solid whitesmoke;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 100;
    font-size: 1.5rem;
    text-decoration: none;
  }

  .exit-reels:hover {
    background: #e74c3c;
    border-color: #e74c3c;
    transform: scale(1.1);
    color: white;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .blog-overlay {
      padding: 1.5rem;
    }

    .blog-top-bar {
      padding: 1rem 1.5rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .blog-title-reel {
      font-size: 1.75rem;
    }

    .blog-excerpt-reel {
      font-size: 1rem;
      -webkit-line-clamp: 4;
    }

    .blog-side-stats {
      right: 1rem;
      bottom: 6rem;
      gap: 1rem;
    }

    .stat-circle {
      width: 50px;
      height: 50px;
      padding: 0.75rem;
      border: 2px solid #3498db;
    }

    .stat-circle i {
      font-size: 1.2rem;
    }

    .stat-circle span {
      font-size: 0.7rem;
    }

    .nav-arrows {
      display: none;
    }

    .blog-interaction-bar {
      flex-direction: column;
      align-items: stretch;
    }

    .interaction-left {
      flex-wrap: wrap;
      justify-content: center;
    }

    .view-full-reel-btn {
      justify-content: center;
    }

    .exit-reels {
      top: 1rem;
      right: 1rem;
      width: 40px;
      height: 40px;
      font-size: 1.2rem;
    }
  }

  /* Fade in animation */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .blog-reel {
    animation: fadeIn 0.5s ease;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const reelsFeed = document.getElementById('reels-feed');
  const loadingOverlay = document.getElementById('loading-overlay');
  const currentIndexDisplay = document.getElementById('current-index');
  const prevBtn = document.getElementById('prev-blog');
  const nextBtn = document.getElementById('next-blog');

  let blogs = [];
  let currentIndex = 0;
  let isLoading = false;
  let hasMore = true;
  let initialBlogId = '{{ initial_blog_id }}';

  // Get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // Initialize - Load first batch
  loadNextBlogs(true);

  // Scroll event with debouncing
  let scrollTimeout;
  reelsFeed.addEventListener('scroll', () => {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
      handleScroll();
    }, 150);
  });

  function handleScroll() {
    const scrollTop = reelsFeed.scrollTop;
    const scrollHeight = reelsFeed.scrollHeight;
    const clientHeight = reelsFeed.clientHeight;

    // Calculate current index based on scroll position
    const newIndex = Math.round(scrollTop / clientHeight);
    
    if (newIndex !== currentIndex) {
      currentIndex = newIndex;
      updateUI();
    }

    // Load more when near the end
    if (scrollTop + clientHeight >= scrollHeight - clientHeight * 2 && hasMore && !isLoading) {
      loadNextBlogs();
    }
  }

  function updateUI() {
    currentIndexDisplay.textContent = currentIndex + 1;
    
    // Update navigation buttons
    prevBtn.disabled = currentIndex === 0;
    nextBtn.disabled = currentIndex >= blogs.length - 1 && !hasMore;
  }

  // Navigation button handlers
  prevBtn.addEventListener('click', () => {
    if (currentIndex > 0) {
      scrollToIndex(currentIndex - 1);
    }
  });

  nextBtn.addEventListener('click', () => {
    if (currentIndex < blogs.length - 1) {
      scrollToIndex(currentIndex + 1);
    } else if (hasMore) {
      loadNextBlogs();
    }
  });

  function scrollToIndex(index) {
    const targetScroll = index * window.innerHeight;
    reelsFeed.scrollTo({
      top: targetScroll,
      behavior: 'smooth'
    });
  }

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowUp' && currentIndex > 0) {
      scrollToIndex(currentIndex - 1);
    } else if (e.key === 'ArrowDown' && currentIndex < blogs.length - 1) {
      scrollToIndex(currentIndex + 1);
    } else if (e.key === 'ArrowDown' && hasMore) {
      loadNextBlogs();
    }
  });

  // Touch swipe support
  let touchStartY = 0;
  let touchEndY = 0;

  reelsFeed.addEventListener('touchstart', (e) => {
    touchStartY = e.touches[0].clientY;
  }, { passive: true });

  reelsFeed.addEventListener('touchend', (e) => {
    touchEndY = e.changedTouches[0].clientY;
    handleSwipe();
  }, { passive: true });

  function handleSwipe() {
    const swipeDistance = touchStartY - touchEndY;
    if (Math.abs(swipeDistance) > 50) {
      if (swipeDistance > 0 && currentIndex < blogs.length - 1) {
        scrollToIndex(currentIndex + 1);
      } else if (swipeDistance < 0 && currentIndex > 0) {
        scrollToIndex(currentIndex - 1);
      }
    }
  }

  function loadNextBlogs(isInitial = false) {
    if (isLoading) return;

    isLoading = true;
    loadingOverlay.classList.add('active');

    const offset = blogs.length;
    const currentBlogId = blogs.length > 0 ? blogs[blogs.length - 1].id : initialBlogId;

    fetch(`/api/get-next-blogs/?current_blog_id=${currentBlogId}&offset=${isInitial ? 0 : offset}`)
      .then(response => response.json())
      .then(data => {
        if (data.success && data.blogs.length > 0) {
          data.blogs.forEach(blog => {
            blogs.push(blog);
            appendBlogReel(blog);
          });

          hasMore = data.has_more;

          if (isInitial) {
            // Scroll to first blog after initial load
            setTimeout(() => {
              scrollToIndex(0);
              updateUI();
            }, 100);
          }
        } else {
          hasMore = false;
        }

        isLoading = false;
        loadingOverlay.classList.remove('active');
      })
      .catch(error => {
        console.error('Error loading blogs:', error);
        isLoading = false;
        loadingOverlay.classList.remove('active');
      });
  }

  function appendBlogReel(blog) {
    const excerpt = blog.content.length > 400 
      ? blog.content.substring(0, 400) + '...' 
      : blog.content;

    const reel = document.createElement('div');
    reel.className = 'blog-reel';
    reel.dataset.blogId = blog.id;

    const authorInitial = blog.author ? blog.author.charAt(0).toUpperCase() : 'A';
    
    reel.innerHTML = `
      <div class="blog-background">
        <img src="${blog.featureImage}" alt="${blog.title}" loading="lazy">
      </div>

      <div class="blog-top-bar">
        <div class="blog-category-tag">
          <i class="fas fa-folder"></i>
          ${blog.category}
        </div>
        <div class="blog-author-info">
          <div class="author-avatar">${authorInitial}</div>
          <span>${blog.author}</span>
        </div>
      </div>

      <div class="blog-overlay">
        <div class="blog-content-area">
          <h1 class="blog-title-reel">${blog.title}</h1>
          
          <div class="blog-meta-reel">
            <div class="meta-item">
              <i class="fas fa-calendar"></i>
              <span>${blog.created}</span>
            </div>
          </div>

          <p class="blog-excerpt-reel">${excerpt}</p>

          <div class="blog-interaction-bar">
            <div class="interaction-left">
              ${getUserAuthStatus() ? `
                <button class="reel-btn like-btn ${blog.user_reaction === 'like' ? 'active' : ''}"
                        data-reaction="like"
                        data-blog-id="${blog.id}">
                  <i class="fas fa-thumbs-up"></i>
                  <span class="like-count">${blog.likes_count}</span>
                </button>

                <button class="reel-btn dislike-btn ${blog.user_reaction === 'dislike' ? 'active' : ''}"
                        data-reaction="dislike"
                        data-blog-id="${blog.id}">
                  <i class="fas fa-thumbs-down"></i>
                  <span class="dislike-count">${blog.dislikes_count}</span>
                </button>
              ` : `
                <a href="/accounts/login" class="reel-btn like-btn">
                  <i class="fas fa-thumbs-up"></i>
                  <span>${blog.likes_count}</span>
                </a>
                <a href="/accounts/login" class="reel-btn dislike-btn">
                  <i class="fas fa-thumbs-down"></i>
                  <span>${blog.dislikes_count}</span>
                </a>
              `}
                <div class="stat-circle">
                    <i class="fas fa-eye"></i>
                    <span>${formatNumber(blog.views)}</span>
                </div>
                <div class="stat-circle">
                    <i class="fas fa-comments"></i>
                    <span>${formatNumber(blog.comments_count)}</span>
                </div>
            </div>

            <a href="/blog/${blog.id}/" class="view-full-reel-btn">
              <i class="fas fa-book-open"></i>
              Read Full
            </a>
          </div>
        </div>
      </div>

      
    `;

    reelsFeed.appendChild(reel);

    // Track view
    trackInteraction(blog.id, 'view');

    // Add reaction listeners
    if (getUserAuthStatus()) {
      const likeBtn = reel.querySelector('.like-btn[data-reaction]');
      const dislikeBtn = reel.querySelector('.dislike-btn[data-reaction]');

      if (likeBtn) {
        likeBtn.addEventListener('click', () => handleReaction(blog.id, 'like', reel));
      }
      if (dislikeBtn) {
        dislikeBtn.addEventListener('click', () => handleReaction(blog.id, 'dislike', reel));
      }
    }
  }

  function handleReaction(blogId, reaction, reelElement) {
    fetch(`/blog/${blogId}/reaction/${reaction}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/json',
      },
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Update counts
        const likeCount = reelElement.querySelector('.like-count');
        const dislikeCount = reelElement.querySelector('.dislike-count');

        if (likeCount) likeCount.textContent = data.likes;
        if (dislikeCount) dislikeCount.textContent = data.dislikes;

        // Update button states
        const likeBtn = reelElement.querySelector('.like-btn[data-reaction]');
        const dislikeBtn = reelElement.querySelector('.dislike-btn[data-reaction]');

        if (likeBtn) likeBtn.classList.remove('active');
        if (dislikeBtn) dislikeBtn.classList.remove('active');

        if (data.user_reaction === 'like') {
          likeBtn.classList.add('active');
        } else if (data.user_reaction === 'dislike') {
          dislikeBtn.classList.add('active');
        }
      }
    })
    .catch(error => console.error('Error:', error));
  }

  function trackInteraction(blogId, type) {
    // Interaction is tracked on the backend when viewing the blog
  }

  function formatNumber(num) {
    if (num >= 1000000) {
      return (num / 1000000).toFixed(1) + 'M';
    } else if (num >= 1000) {
      return (num / 1000).toFixed(1) + 'K';
    }
    return num.toString();
  }

  function getUserAuthStatus() {
    return {{ user.is_authenticated|yesno:"true,false" }};
  }
});
</script>
{% endblock maincontent %}